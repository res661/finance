<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Finance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/MorphSVGPlugin.min.js"></script>
    <style>
        :root {
            --bg: #0a0e1a;
            --glass: rgba(255,255,255,0.05);
            --accent: #00a3ff;
            --text: rgba(255,255,255,0.95);
            --positive: #00ff88;
            --negative: #ff467e;
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        :root.light-theme {
            --bg: #f0f4f8;
            --glass: rgba(0,0,0,0.05);
            --accent: #0077ff;
            --text: rgba(0,0,0,0.95);
            --positive: #00c853;
            --negative: #ff1744;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden;
            position: relative;
            transition: background-color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0,163,255,0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0,255,136,0.1) 0%, transparent 20%);
            z-index: -1;
            animation: gradientMove 20s ease-in-out infinite alternate;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        .floating-particle {
            position: fixed;
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.5;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr 1fr;
        }

        .balance-card {
            background: var(--glass);
            padding: 2rem;
            border-radius: 24px;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            grid-column: span 2;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,163,255,0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: rotateGradient 10s linear infinite;
        }

        @keyframes rotateGradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            height: 400px;
            background: var(--glass);
            border-radius: 24px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            grid-column: span 2;
            transition: opacity 0.3s ease-in-out;
        }

        .transactions-list {
            display: grid;
            gap: 1rem;
            grid-column: span 2;
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            animation: itemAppear 0.6s ease;
            transition: var(--transition);
        }

        .transaction-item:hover {
            transform: translateX(10px);
        }

        .add-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 30px rgba(0,163,255,0.3);
        }

        .add-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 0 50px rgba(0,163,255,0.5);
        }

        @keyframes itemAppear {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glow-line {
            filter: drop-shadow(0 0 10px rgba(0,163,255,0.5));
        }

        .chart-glow {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(0deg, rgba(0,163,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .nav-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .nav-bar ion-icon {
            font-size: 24px;
            color: var(--accent);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            padding: 10px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .nav-bar ion-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0,163,255,0.3);
        }

        .profit-loss {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .profit-loss > div {
            background: var(--glass);
            padding: 1.5rem;
            border-radius: 16px;
        }

        .period-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .period-button {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .period-button.active {
            background: var(--accent);
            color: white;
        }

        .search-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            grid-column: span 2;
        }

        .search-input {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            width: 100%;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tab {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            width: 80%;
            max-width: 500px;
            border-radius: 24px;
        }
        .modal-content {
            background: rgba(10, 14, 26, 0.8);
            backdrop-filter: blur(10px);
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
        }

        .neon-input {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        .neon-button {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            margin-top: 1rem;
        }
        .neon-button {
            transition: all 0.3s ease;
        }

        .neon-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(0,163,255,0.8);
        }

        .neon-select {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 1rem;
            appearance: none;
        }
        .neon-input:focus, .neon-select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0,163,255,0.5);
        }

        .modal-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(0,163,255,0.3);
        }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--glass);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0077ff;
        }

        .floating-star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.5;
            animation: starFloat 15s linear infinite;
        }

        @keyframes starFloat {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0,163,255,0.3);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text);
        }

        .calendar-container {
            display: none;
            height: 400px;
            background: var(--glass);
            border-radius: 24px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            grid-column: span 2;
            transition: opacity 0.3s ease-in-out;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav button {
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: var(--transition);
        }

        .calendar-nav button:hover {
            background: var(--accent);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            background: var(--glass);
            border-radius: 16px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-day:hover {
            background: var(--accent);
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--accent);
        }

        .calendar-day .day-number {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .calendar-day .day-balance {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        .positive-balance {
            color: var(--positive);
        }

        .negative-balance {
            color: var(--negative);
        }

        .switch-view {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 2rem;
            cursor: pointer;
            width: 50px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 10;
        }

        .switch-view:hover {
            background: var(--accent);
            color: white;
            width: 60px;
        }

        .switch-view.left {
            left: -1px;
            border-radius: 0 25px 25px 0;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .switch-view.right {
            right: -1px;
            border-radius: 25px 0 0 25px;
            justify-content: flex-start;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        <svg viewBox="0 0 24 24" id="theme-icon">
            <path id="moon" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            <circle id="sun" cx="12" cy="12" r="5" style="display:none;"/>
            <line id="sun-ray-1" x1="12" y1="1" x2="12" y2="3" style="display:none;"/>
            <line id="sun-ray-2" x1="12" y1="21" x2="12" y2="23" style="display:none;"/>
            <line id="sun-ray-3" x1="4.22" y1="4.22" x2="5.64" y2="5.64" style="display:none;"/>
            <line id="sun-ray-4" x1="18.36" y1="18.36" x2="19.78" y2="19.78" style="display:none;"/>
            <line id="sun-ray-5" x1="1" y1="12" x2="3" y2="12" style="display:none;"/>
            <line id="sun-ray-6" x1="21" y1="12" x2="23" y2="12" style="display:none;"/>
            <line id="sun-ray-7" x1="4.22" y1="19.78" x2="5.64" y2="18.36" style="display:none;"/>
            <line id="sun-ray-8" x1="18.36" y1="5.64" x2="19.78" y2="4.22" style="display:none;"/>
        </svg>
    </div>

    <div class="nav-bar">
        <ion-icon name="trophy-outline" onclick="window.location.href='target.html'"></ion-icon>
        <ion-icon name="library-outline" onclick="window.location.href='library.html'"></ion-icon>
        <ion-icon name="download-outline" onclick="exportTransactions()"></ion-icon>
        <ion-icon name="cloud-upload-outline" onclick="document.getElementById('fileInput').click()"></ion-icon>
    </div>

    <div class="dashboard">
        <div class="balance-card">
            <h2>Общий баланс</h2>
            <h1 id="totalBalance">$0</h1>
            <div class="period-buttons">
                <button class="period-button" onclick="changePeriod('day')">День</button>
                <button class="period-button" onclick="changePeriod('week')">Неделя</button>
                <button class="period-button" onclick="changePeriod('month')">Месяц</button>
                <button class="period-button active" onclick="changePeriod('all')">Все</button>
            </div>
        </div>

        <div class="profit-loss">
            <div>
                <h3>Общий доход</h3>
                <h2 id="totalIncome">$0</h2>
            </div>
            <div>
                <h3>Общий расход</h3>
                <h2 id="totalExpense">$0</h2>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-glow"></div>
            <canvas id="mainChart" class="glow-line"></canvas>
        </div>
        <button class="switch-view right" onclick="switchToCalendar()">❯</button>

        <div class="calendar-container">
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">←</button>
                <h2 id="currentMonth"></h2>
                <button onclick="changeMonth(1)">→</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <button class="switch-view left" onclick="switchToChart()">❮</button>

        <div class="search-container">
            <input type="date" id="searchDate" class="search-input" onchange="filterTransactions()">
        </div>

        <div class="transactions-list" id="transactions"></div>

        <button class="add-btn" onclick="openModal()">+</button>
    </div>

    <!-- Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Добавить транзакцию</h2>
            <select id="transactionType" class="neon-select" onchange="toggleTransactionFields()">
                <option value="simple">Простая транзакция</option>
                <option value="advanced">Расширенная сделка</option>
            </select>
            <div id="simpleTransactionFields">
                <select id="type" class="neon-select">
                    <option value="income">Доход</option>
                    <option value="expense">Расход</option>
                </select>
                <input type="number" id="amount" placeholder="Сумма" class="neon-input">
                <input type="date" id="date" class="neon-input">
                <textarea id="description" placeholder="Описание" rows="3" class="neon-input"></textarea>
                <button onclick="addTransaction()" class="neon-button">Добавить</button>
            </div>
            <div id="advancedTransactionFields" style="display:none;">
                <input type="text" id="skinName" placeholder="Название скина" class="neon-input">
                <input type="number" id="buyPrice" placeholder="Цена покупки ($)" class="neon-input">
                <input type="number" id="sellPrice" placeholder="Цена продажи ($)" class="neon-input">
                <select id="profitPercentage" class="neon-select">
                    <option value="2">2%</option>
                    <option value="5">5%</option>
                    <option value="10">10%</option>
                    <option value="13">13%</option>
                </select>
                <input type="date" id="advancedDate" class="neon-input">
                <button onclick="calculateProfit()" class="neon-button">Рассчитать</button>
                <div id="calculationResult"></div>
                <button onclick="addAdvancedTransaction()" class="neon-button" id="addAdvancedTransactionBtn" style="display:none;">Добавить сделку</button>
            </div>
        </div>
    </div>

    <!-- Скрытый input для импорта -->
    <input type="file" id="fileInput" style="display:none" onchange="importTransactions(event)">

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let chart;
        let currentPeriod = 'all';
        let lastCalculatedProfit = 0;
        let currentDate = new Date();

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0,163,255,0.4)');
            gradient.addColorStop(1, 'rgba(0,163,255,0)');

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Balance',
                        data: [],
                        borderColor: '#00a3ff',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: gradient,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(10,14,26,0.9)',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 12
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.5)' }
                        },
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.5)',
                                callback: value => '$' + value
                            }
                        }
                    }
                }
            });
        }

        function updateBalance() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            const balance = filteredTransactions.reduce((acc, t) => 
                t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            document.getElementById('totalBalance').textContent = `$${balance.toLocaleString()}`;
        }

        function renderTransactions() {
            const container = document.getElementById('transactions');
            container.innerHTML = transactions.map((t, i) => `
                <div class="transaction-item">
                    <div>
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem">
                        <span style="color: ${t.type === 'income' ? 'var(--positive)' : 'var(--negative)'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                        </span>
                        <button onclick="editTransaction(${i})" class="neon-button">✎</button>
                        <button onclick="confirmDelete(${i})" class="neon-button">×</button>
                    </div>
                </div>
            `).join('');
        }

        function addTransaction() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (!amount || amount <= 0) return alert('Введите корректную сумму');
            
            const transaction = {
                type: document.getElementById('type').value,
                amount: amount,
                description: document.getElementById('description').value,
                date: document.getElementById('date').value || new Date().toISOString().split('T')[0]
            };
            
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
            closeModal();
        }

        function calculateProfit() {
            const skinName = document.getElementById('skinName').value;
            const buy = parseFloat(document.getElementById('buyPrice').value);
            const sell = parseFloat(document.getElementById('sellPrice').value);
            const percent = parseFloat(document.getElementById('profitPercentage').value);
            
            const fee = sell * (percent / 100);
            const profit = sell - buy - fee;
            lastCalculatedProfit = profit;

            const resultHTML = `
                <p style="margin-top:1rem">Тема: ${skinName}</p>
                <p>Цена покупки: $${buy.toFixed(2)}</p>
                <p>Цена продажи: $${sell.toFixed(2)}</p>
                <p>Комиссия: $${fee.toFixed(2)} (${percent}%)</p>
                <p>Прибыль: <span class="${profit >= 0 ? 'positive' : 'negative'}">$${profit.toFixed(2)}</span></p>
            `;
            
            document.getElementById('calculationResult').innerHTML = resultHTML;
            document.getElementById('addAdvancedTransactionBtn').style.display = 'block';
        }

        function addAdvancedTransaction() {
            if (lastCalculatedProfit <= 0) return alert('Сначала рассчитайте прибыль');

            const skinName = document.getElementById('skinName').value;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);
            const percent = parseFloat(document.getElementById('profitPercentage').value);

            const transaction = {
                type: 'income',
                amount: lastCalculatedProfit,
                description: `$${lastCalculatedProfit.toFixed(2)} прибыль (тема: ${skinName})`,
                date: document.getElementById('advancedDate').value || new Date().toISOString().split('T')[0],
                theme: skinName,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                commission: percent
            };

            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
            closeModal();
        }

        function exportTransactions() {
            const data = JSON.stringify(transactions, null, 2);
            const blob = new Blob([data], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions.txt';
            a.click();
        }

        function importTransactions(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                transactions = JSON.parse(e.target.result);
                updateUI();
            };
            reader.readAsText(file);
        }

        function updateProfitLoss() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            const income = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((acc, t) => acc + t.amount, 0);
            
            const expense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => acc + t.amount, 0);
            
            document.getElementById('totalIncome').textContent = `$${income.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `$${expense.toLocaleString()}`;
        }

        function editTransaction(index) {
            const t = transactions[index];
            document.getElementById('transactionType').value = t.theme ? 'advanced' : 'simple';
            toggleTransactionFields();
            if (t.theme) {
                document.getElementById('skinName').value = t.theme;
                document.getElementById('buyPrice').value = t.buyPrice;
                document.getElementById('sellPrice').value = t.sellPrice;
                document.getElementById('profitPercentage').value = t.commission;
                document.getElementById('advancedDate').value = t.date;
                calculateProfit();            } else {
                document.getElementById('type').value = t.type;
                document.getElementById('amount').value = t.amount;
                document.getElementById('description').value = t.description;
                document.getElementById('date').value = t.date;
            }
            openModal();
            transactions.splice(index, 1);
            updateUI();
        }

        function confirmDelete(index) {
            if (confirm('Вы уверены, что хотите удалить эту транзакцию?')) {
                deleteTransaction(index);
            }
        }

        function deleteTransaction(index) {
            transactions.splice(index, 1);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
        }

        function openModal() {
            document.getElementById('transactionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
            clearInputs();
        }

        function updateChart() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            const balanceHistory = filteredTransactions.reduce((acc, t) => {
                const last = acc.length > 0 ? acc[acc.length-1] : 0;
                acc.push(t.type === 'income' ? last + t.amount : last - t.amount);
                return acc;
            }, []);

            chart.data.labels = filteredTransactions.map(t => 
                new Date(t.date).toLocaleDateString('ru-RU', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
            chart.data.datasets[0].data = balanceHistory;
            chart.update();
        }

        function updateUI() {
            updateBalance();
            updateProfitLoss();
            renderTransactions();
            updateChart();
            renderCalendar();
        }

        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === period);
            });
            updateUI();
        }

        function filterTransactionsByPeriod(transactions, period) {
            const now = new Date();
            let startDate;

            switch(period) {
                case 'day':
                    startDate = new Date(now.setDate(now.getDate() - 1));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    return transactions;
            }

            return transactions.filter(t => new Date(t.date) >= startDate);
        }

        function filterTransactions() {
            const searchDate = document.getElementById('searchDate').value;
            if (!searchDate) {
                renderTransactions();
                return;
            }

            const filteredTransactions = transactions.filter(t => 
                t.date === searchDate
            );
            
            const container = document.getElementById('transactions');
            container.innerHTML = filteredTransactions.map((t, i) => `
                <div class="transaction-item">
                    <div>
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem">
                        <span style="color: ${t.type === 'income' ? 'var(--positive)' : 'var(--negative)'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                        </span>
                        <button onclick="editTransaction(${transactions.indexOf(t)})" class="neon-button">✎</button>
                        <button onclick="confirmDelete(${transactions.indexOf(t)})" class="neon-button">×</button>
                    </div>
                </div>
            `).join('');
        }

        function clearInputs() {
            document.getElementById('type').value = 'income';
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('date').value = '';
            document.getElementById('skinName').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('profitPercentage').value = '2';
            document.getElementById('advancedDate').value = '';
            document.getElementById('calculationResult').innerHTML = '';
            document.getElementById('addAdvancedTransactionBtn').style.display = 'none';
        }

        function toggleTransactionFields() {
            const type = document.getElementById('transactionType').value;
            document.getElementById('simpleTransactionFields').style.display = type === 'simple' ? 'block' : 'none';
            document.getElementById('advancedTransactionFields').style.display = type === 'advanced' ? 'block' : 'none';
        }

        function createFloatingParticles() {
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'particles-container';
            document.body.appendChild(particlesContainer);

            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'floating-particle';
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = `${Math.random() * 100}vh`;
                particle.style.animationDuration = `${Math.random() * 10 + 5}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particlesContainer.appendChild(particle);
            }
        }

        function createFloatingStars() {
            const starsContainer = document.createElement('div');
            starsContainer.className = 'stars-container';
            document.body.appendChild(starsContainer);

            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'floating-star';
                star.style.left = `${Math.random() * 100}vw`;
                star.style.animationDuration = `${Math.random() * 10 + 5}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starsContainer.appendChild(star);
            }
        }

        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = root.classList.contains('light-theme') ? 'dark' : 'light';
            root.classList.toggle('light-theme');

            const tl = gsap.timeline();

            if (currentTheme === 'light') {
                // Анимация от солнца к луне
                tl.to("#sun, #sun-ray-1, #sun-ray-2, #sun-ray-3, #sun-ray-4, #sun-ray-5, #sun-ray-6, #sun-ray-7, #sun-ray-8", {duration: 0.3, opacity: 0})
                  .to("#moon", {duration: 0.5, morphSVG: "M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z", ease: "power2.inOut"}, "-=0.3");
            } else {
                // Анимация от луны к солнцу
                tl.to("#moon", {duration: 0.5, morphSVG: "M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z", ease: "power2.inOut"})
                  .to("#sun", {duration: 0.1, opacity: 1})
                  .to("#sun-ray-1, #sun-ray-2, #sun-ray-3, #sun-ray-4, #sun-ray-5, #sun-ray-6, #sun-ray-7, #sun-ray-8", {duration: 0.3, opacity: 1, stagger: 0.05}, "-=0.1");
            }

            // Обновляем цвета графика
            updateChartColors();
        }

        function updateChartColors() {
            const root = document.documentElement;
            const isDarkTheme = !root.classList.contains('light-theme');

            const newChartOptions = {
                scales: {
                    x: { 
                        grid: { color: isDarkTheme ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                        ticks: { color: isDarkTheme ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)' }
                    },
                    y: { 
                        grid: { color: isDarkTheme ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                        ticks: { 
                            color: isDarkTheme ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)',
                            callback: value => '$' + value
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: isDarkTheme ? 'rgba(10,14,26,0.9)' : 'rgba(240,244,248,0.9)',
                        bodyColor: isDarkTheme ? '#fff' : '#000',
                        borderColor: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                    }
                }
            };

            chart.options = { ...chart.options, ...newChartOptions };
            chart.update();
        }

        function switchToCalendar() {
            const chartContainer = document.querySelector('.chart-container');
            const calendarContainer = document.querySelector('.calendar-container');
            const rightButton = document.querySelector('.switch-view.right');
            const leftButton = document.querySelector('.switch-view.left');

            gsap.to(chartContainer, { opacity: 0, duration: 0.3, onComplete: () => {
                chartContainer.style.display = 'none';
                calendarContainer.style.display = 'block';
                gsap.fromTo(calendarContainer, { opacity: 0 }, { opacity: 1, duration: 0.3 });
            }});

            rightButton.style.display = 'none';
            leftButton.style.display = 'flex';
            renderCalendar();
        }

        function switchToChart() {
            const chartContainer = document.querySelector('.chart-container');
            const calendarContainer = document.querySelector('.calendar-container');
            const rightButton = document.querySelector('.switch-view.right');
            const leftButton = document.querySelector('.switch-view.left');

            gsap.to(calendarContainer, { opacity: 0, duration: 0.3, onComplete: () => {
                calendarContainer.style.display = 'none';
                chartContainer.style.display = 'block';
                gsap.fromTo(chartContainer, { opacity: 0 }, { opacity: 1, duration: 0.3 });
            }});

            leftButton.style.display = 'none';
            rightButton.style.display = 'flex';
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');

            // Очищаем текущий календарь
            calendarGrid.innerHTML = '';

            // Устанавливаем текущий месяц и год
            currentMonthElement.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Получаем первый день месяца
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // Добавляем дни недели
            const weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });

            // Добавляем пустые ячейки до первого дня месяца
            for (let i = 0; i < (firstDay.getDay() || 7) - 1; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }

            // Добавляем дни месяца
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = i;
                
                const dayBalance = document.createElement('div');
                dayBalance.className = 'day-balance';
                
                const currentDayTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getDate() === i &&
                           transactionDate.getMonth() === currentDate.getMonth() &&
                           transactionDate.getFullYear() === currentDate.getFullYear();
                });
                
                const dayTotal = currentDayTransactions.reduce((acc, t) => 
                    t.type === 'income' ? acc + t.amount : acc - t.amount, 0
                );
                
                if (dayTotal !== 0) {
                    dayBalance.textContent = `${dayTotal > 0 ? '+' : ''}$${dayTotal.toFixed(2)}`;
                    dayBalance.classList.add(dayTotal > 0 ? 'positive-balance' : 'negative-balance');
                }
                
                dayElement.appendChild(dayNumber);
                dayElement.appendChild(dayBalance);
                
                if (i === new Date().getDate() && 
                    currentDate.getMonth() === new Date().getMonth() && 
                    currentDate.getFullYear() === new Date().getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // Инициализация
        initChart();
        updateUI();
        createFloatingParticles();
        createFloatingStars();
        document.querySelector('.switch-view.left').style.display = 'none';

        // Обработчики событий
        window.onclick = function(event) {
            if (event.target == document.getElementById('transactionModal')) {
                closeModal();
            }
        }
    </script>
</body>
</html>

